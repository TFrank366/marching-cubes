#include <emscripten.h>
#include <stdlib.h>

//memory loaded with tables in order vertCoordTable, edgeTable, edgeToVertsTable, triTable

typedef float vert[3];

extern void console_log(float);
extern void console_log_bin(int);

int vertCoordTable[8][3] = {
    {0, 0, 0}, // 0
    {1, 0, 0}, // 1
    {1, 1, 0}, // 2
    {0, 1, 0}, // 3
    {0, 0, 1}, // 4
    {1, 0, 1}, // 5
    {1, 1, 1}, // 6
    {0, 1, 1}, // 7
};

int edgeTable[256][12] = {
    {-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,3,8,9,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,8,10,-1,-1,-1,-1,-1,-1},
    {0,2,9,10,-1,-1,-1,-1,-1,-1,-1,-1},
    {2,3,8,9,10,-1,-1,-1,-1,-1,-1,-1},
    {2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,2,8,11,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,9,11,-1,-1,-1,-1,-1,-1},
    {1,2,8,9,11,-1,-1,-1,-1,-1,-1,-1},
    {1,3,10,11,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,8,10,11,-1,-1,-1,-1,-1,-1,-1},
    {0,3,9,10,11,-1,-1,-1,-1,-1,-1,-1},
    {8,9,10,11,-1,-1,-1,-1,-1,-1,-1,-1},
    {4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,3,4,7,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,4,7,8,9,-1,-1,-1,-1,-1,-1},
    {1,3,4,7,9,-1,-1,-1,-1,-1,-1,-1},
    {1,2,4,7,8,10,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,4,7,10,-1,-1,-1,-1,-1},
    {0,2,4,7,8,9,10,-1,-1,-1,-1,-1},
    {2,3,4,7,9,10,-1,-1,-1,-1,-1,-1},
    {2,3,4,7,8,11,-1,-1,-1,-1,-1,-1},
    {0,2,4,7,11,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,4,7,8,9,11,-1,-1,-1},
    {1,2,4,7,9,11,-1,-1,-1,-1,-1,-1},
    {1,3,4,7,8,10,11,-1,-1,-1,-1,-1},
    {0,1,4,7,10,11,-1,-1,-1,-1,-1,-1},
    {0,3,4,7,8,9,10,11,-1,-1,-1,-1},
    {4,7,9,10,11,-1,-1,-1,-1,-1,-1,-1},
    {4,5,9,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,3,4,5,8,9,-1,-1,-1,-1,-1,-1},
    {0,1,4,5,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,3,4,5,8,-1,-1,-1,-1,-1,-1,-1},
    {1,2,4,5,9,10,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,4,5,8,9,10,-1,-1,-1},
    {0,2,4,5,10,-1,-1,-1,-1,-1,-1,-1},
    {2,3,4,5,8,10,-1,-1,-1,-1,-1,-1},
    {2,3,4,5,9,11,-1,-1,-1,-1,-1,-1},
    {0,2,4,5,8,9,11,-1,-1,-1,-1,-1},
    {0,1,2,3,4,5,11,-1,-1,-1,-1,-1},
    {1,2,4,5,8,11,-1,-1,-1,-1,-1,-1},
    {1,3,4,5,9,10,11,-1,-1,-1,-1,-1},
    {0,1,4,5,8,9,10,11,-1,-1,-1,-1},
    {0,3,4,5,10,11,-1,-1,-1,-1,-1,-1},
    {4,5,8,10,11,-1,-1,-1,-1,-1,-1,-1},
    {5,7,8,9,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,3,5,7,9,-1,-1,-1,-1,-1,-1,-1},
    {0,1,5,7,8,-1,-1,-1,-1,-1,-1,-1},
    {1,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,2,5,7,8,9,10,-1,-1,-1,-1,-1},
    {0,1,2,3,5,7,9,10,-1,-1,-1,-1},
    {0,2,5,7,8,10,-1,-1,-1,-1,-1,-1},
    {2,3,5,7,10,-1,-1,-1,-1,-1,-1,-1},
    {2,3,5,7,8,9,11,-1,-1,-1,-1,-1},
    {0,2,5,7,9,11,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,5,7,8,11,-1,-1,-1,-1},
    {1,2,5,7,11,-1,-1,-1,-1,-1,-1,-1},
    {1,3,5,7,8,9,10,11,-1,-1,-1,-1},
    {0,1,5,7,9,10,11,-1,-1,-1,-1,-1},
    {0,3,5,7,8,10,11,-1,-1,-1,-1,-1},
    {5,7,10,11,-1,-1,-1,-1,-1,-1,-1,-1},
    {5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,3,5,6,8,10,-1,-1,-1,-1,-1,-1},
    {0,1,5,6,9,10,-1,-1,-1,-1,-1,-1},
    {1,3,5,6,8,9,10,-1,-1,-1,-1,-1},
    {1,2,5,6,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,5,6,8,-1,-1,-1,-1,-1},
    {0,2,5,6,9,-1,-1,-1,-1,-1,-1,-1},
    {2,3,5,6,8,9,-1,-1,-1,-1,-1,-1},
    {2,3,5,6,10,11,-1,-1,-1,-1,-1,-1},
    {0,2,5,6,8,10,11,-1,-1,-1,-1,-1},
    {0,1,2,3,5,6,9,10,11,-1,-1,-1},
    {1,2,5,6,8,9,10,11,-1,-1,-1,-1},
    {1,3,5,6,11,-1,-1,-1,-1,-1,-1,-1},
    {0,1,5,6,8,11,-1,-1,-1,-1,-1,-1},
    {0,3,5,6,9,11,-1,-1,-1,-1,-1,-1},
    {5,6,8,9,11,-1,-1,-1,-1,-1,-1,-1},
    {4,5,6,7,8,10,-1,-1,-1,-1,-1,-1},
    {0,3,4,5,6,7,10,-1,-1,-1,-1,-1},
    {0,1,4,5,6,7,8,9,10,-1,-1,-1},
    {1,3,4,5,6,7,9,10,-1,-1,-1,-1},
    {1,2,4,5,6,7,8,-1,-1,-1,-1,-1},
    {0,1,2,3,4,5,6,7,-1,-1,-1,-1},
    {0,2,4,5,6,7,8,9,-1,-1,-1,-1},
    {2,3,4,5,6,7,9,-1,-1,-1,-1,-1},
    {2,3,4,5,6,7,8,10,11,-1,-1,-1},
    {0,2,4,5,6,7,10,11,-1,-1,-1,-1},
    {0,1,2,3,4,5,6,7,8,9,10,11},
    {1,2,4,5,6,7,9,10,11,-1,-1,-1},
    {1,3,4,5,6,7,8,11,-1,-1,-1,-1},
    {0,1,4,5,6,7,11,-1,-1,-1,-1,-1},
    {0,3,4,5,6,7,8,9,11,-1,-1,-1},
    {4,5,6,7,9,11,-1,-1,-1,-1,-1,-1},
    {4,6,9,10,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,3,4,6,8,9,10,-1,-1,-1,-1,-1},
    {0,1,4,6,10,-1,-1,-1,-1,-1,-1,-1},
    {1,3,4,6,8,10,-1,-1,-1,-1,-1,-1},
    {1,2,4,6,9,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,4,6,8,9,-1,-1,-1,-1},
    {0,2,4,6,-1,-1,-1,-1,-1,-1,-1,-1},
    {2,3,4,6,8,-1,-1,-1,-1,-1,-1,-1},
    {2,3,4,6,9,10,11,-1,-1,-1,-1,-1},
    {0,2,4,6,8,9,10,11,-1,-1,-1,-1},
    {0,1,2,3,4,6,10,11,-1,-1,-1,-1},
    {1,2,4,6,8,10,11,-1,-1,-1,-1,-1},
    {1,3,4,6,9,11,-1,-1,-1,-1,-1,-1},
    {0,1,4,6,8,9,11,-1,-1,-1,-1,-1},
    {0,3,4,6,11,-1,-1,-1,-1,-1,-1,-1},
    {4,6,8,11,-1,-1,-1,-1,-1,-1,-1,-1},
    {6,7,8,9,10,-1,-1,-1,-1,-1,-1,-1},
    {0,3,6,7,9,10,-1,-1,-1,-1,-1,-1},
    {0,1,6,7,8,10,-1,-1,-1,-1,-1,-1},
    {1,3,6,7,10,-1,-1,-1,-1,-1,-1,-1},
    {1,2,6,7,8,9,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,6,7,9,-1,-1,-1,-1,-1},
    {0,2,6,7,8,-1,-1,-1,-1,-1,-1,-1},
    {2,3,6,7,-1,-1,-1,-1,-1,-1,-1,-1},
    {2,3,6,7,8,9,10,11,-1,-1,-1,-1},
    {0,2,6,7,9,10,11,-1,-1,-1,-1,-1},
    {0,1,2,3,6,7,8,10,11,-1,-1,-1},
    {1,2,6,7,10,11,-1,-1,-1,-1,-1,-1},
    {1,3,6,7,8,9,11,-1,-1,-1,-1,-1},
    {0,1,6,7,9,11,-1,-1,-1,-1,-1,-1},
    {0,3,6,7,8,11,-1,-1,-1,-1,-1,-1},
    {6,7,11,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {6,7,11,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,3,6,7,8,11,-1,-1,-1,-1,-1,-1},
    {0,1,6,7,9,11,-1,-1,-1,-1,-1,-1},
    {1,3,6,7,8,9,11,-1,-1,-1,-1,-1},
    {1,2,6,7,10,11,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,6,7,8,10,11,-1,-1,-1},
    {0,2,6,7,9,10,11,-1,-1,-1,-1,-1},
    {2,3,6,7,8,9,10,11,-1,-1,-1,-1},
    {2,3,6,7,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,2,6,7,8,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,6,7,9,-1,-1,-1,-1,-1},
    {1,2,6,7,8,9,-1,-1,-1,-1,-1,-1},
    {1,3,6,7,10,-1,-1,-1,-1,-1,-1,-1},
    {0,1,6,7,8,10,-1,-1,-1,-1,-1,-1},
    {0,3,6,7,9,10,-1,-1,-1,-1,-1,-1},
    {6,7,8,9,10,-1,-1,-1,-1,-1,-1,-1},
    {4,6,8,11,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,3,4,6,11,-1,-1,-1,-1,-1,-1,-1},
    {0,1,4,6,8,9,11,-1,-1,-1,-1,-1},
    {1,3,4,6,9,11,-1,-1,-1,-1,-1,-1},
    {1,2,4,6,8,10,11,-1,-1,-1,-1,-1},
    {0,1,2,3,4,6,10,11,-1,-1,-1,-1},
    {0,2,4,6,8,9,10,11,-1,-1,-1,-1},
    {2,3,4,6,9,10,11,-1,-1,-1,-1,-1},
    {2,3,4,6,8,-1,-1,-1,-1,-1,-1,-1},
    {0,2,4,6,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,4,6,8,9,-1,-1,-1,-1},
    {1,2,4,6,9,-1,-1,-1,-1,-1,-1,-1},
    {1,3,4,6,8,10,-1,-1,-1,-1,-1,-1},
    {0,1,4,6,10,-1,-1,-1,-1,-1,-1,-1},
    {0,3,4,6,8,9,10,-1,-1,-1,-1,-1},
    {4,6,9,10,-1,-1,-1,-1,-1,-1,-1,-1},
    {4,5,6,7,9,11,-1,-1,-1,-1,-1,-1},
    {0,3,4,5,6,7,8,9,11,-1,-1,-1},
    {0,1,4,5,6,7,11,-1,-1,-1,-1,-1},
    {1,3,4,5,6,7,8,11,-1,-1,-1,-1},
    {1,2,4,5,6,7,9,10,11,-1,-1,-1},
    {0,1,2,3,4,5,6,7,8,9,10,11},
    {0,2,4,5,6,7,10,11,-1,-1,-1,-1},
    {2,3,4,5,6,7,8,10,11,-1,-1,-1},
    {2,3,4,5,6,7,9,-1,-1,-1,-1,-1},
    {0,2,4,5,6,7,8,9,-1,-1,-1,-1},
    {0,1,2,3,4,5,6,7,-1,-1,-1,-1},
    {1,2,4,5,6,7,8,-1,-1,-1,-1,-1},
    {1,3,4,5,6,7,9,10,-1,-1,-1,-1},
    {0,1,4,5,6,7,8,9,10,-1,-1,-1},
    {0,3,4,5,6,7,10,-1,-1,-1,-1,-1},
    {4,5,6,7,8,10,-1,-1,-1,-1,-1,-1},
    {5,6,8,9,11,-1,-1,-1,-1,-1,-1,-1},
    {0,3,5,6,9,11,-1,-1,-1,-1,-1,-1},
    {0,1,5,6,8,11,-1,-1,-1,-1,-1,-1},
    {1,3,5,6,11,-1,-1,-1,-1,-1,-1,-1},
    {1,2,5,6,8,9,10,11,-1,-1,-1,-1},
    {0,1,2,3,5,6,9,10,11,-1,-1,-1},
    {0,2,5,6,8,10,11,-1,-1,-1,-1,-1},
    {2,3,5,6,10,11,-1,-1,-1,-1,-1,-1},
    {2,3,5,6,8,9,-1,-1,-1,-1,-1,-1},
    {0,2,5,6,9,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,5,6,8,-1,-1,-1,-1,-1},
    {1,2,5,6,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,3,5,6,8,9,10,-1,-1,-1,-1,-1},
    {0,1,5,6,9,10,-1,-1,-1,-1,-1,-1},
    {0,3,5,6,8,10,-1,-1,-1,-1,-1,-1},
    {5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {5,7,10,11,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,3,5,7,8,10,11,-1,-1,-1,-1,-1},
    {0,1,5,7,9,10,11,-1,-1,-1,-1,-1},
    {1,3,5,7,8,9,10,11,-1,-1,-1,-1},
    {1,2,5,7,11,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,5,7,8,11,-1,-1,-1,-1},
    {0,2,5,7,9,11,-1,-1,-1,-1,-1,-1},
    {2,3,5,7,8,9,11,-1,-1,-1,-1,-1},
    {2,3,5,7,10,-1,-1,-1,-1,-1,-1,-1},
    {0,2,5,7,8,10,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,5,7,9,10,-1,-1,-1,-1},
    {1,2,5,7,8,9,10,-1,-1,-1,-1,-1},
    {1,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,5,7,8,-1,-1,-1,-1,-1,-1,-1},
    {0,3,5,7,9,-1,-1,-1,-1,-1,-1,-1},
    {5,7,8,9,-1,-1,-1,-1,-1,-1,-1,-1},
    {4,5,8,10,11,-1,-1,-1,-1,-1,-1,-1},
    {0,3,4,5,10,11,-1,-1,-1,-1,-1,-1},
    {0,1,4,5,8,9,10,11,-1,-1,-1,-1},
    {1,3,4,5,9,10,11,-1,-1,-1,-1,-1},
    {1,2,4,5,8,11,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,4,5,11,-1,-1,-1,-1,-1},
    {0,2,4,5,8,9,11,-1,-1,-1,-1,-1},
    {2,3,4,5,9,11,-1,-1,-1,-1,-1,-1},
    {2,3,4,5,8,10,-1,-1,-1,-1,-1,-1},
    {0,2,4,5,10,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,4,5,8,9,10,-1,-1,-1},
    {1,2,4,5,9,10,-1,-1,-1,-1,-1,-1},
    {1,3,4,5,8,-1,-1,-1,-1,-1,-1,-1},
    {0,1,4,5,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,3,4,5,8,9,-1,-1,-1,-1,-1,-1},
    {4,5,9,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {4,7,9,10,11,-1,-1,-1,-1,-1,-1,-1},
    {0,3,4,7,8,9,10,11,-1,-1,-1,-1},
    {0,1,4,7,10,11,-1,-1,-1,-1,-1,-1},
    {1,3,4,7,8,10,11,-1,-1,-1,-1,-1},
    {1,2,4,7,9,11,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,4,7,8,9,11,-1,-1,-1},
    {0,2,4,7,11,-1,-1,-1,-1,-1,-1,-1},
    {2,3,4,7,8,11,-1,-1,-1,-1,-1,-1},
    {2,3,4,7,9,10,-1,-1,-1,-1,-1,-1},
    {0,2,4,7,8,9,10,-1,-1,-1,-1,-1},
    {0,1,2,3,4,7,10,-1,-1,-1,-1,-1},
    {1,2,4,7,8,10,-1,-1,-1,-1,-1,-1},
    {1,3,4,7,9,-1,-1,-1,-1,-1,-1,-1},
    {0,1,4,7,8,9,-1,-1,-1,-1,-1,-1},
    {0,3,4,7,-1,-1,-1,-1,-1,-1,-1,-1},
    {4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {8,9,10,11,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,3,9,10,11,-1,-1,-1,-1,-1,-1,-1},
    {0,1,8,10,11,-1,-1,-1,-1,-1,-1,-1},
    {1,3,10,11,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,2,8,9,11,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,9,11,-1,-1,-1,-1,-1,-1},
    {0,2,8,11,-1,-1,-1,-1,-1,-1,-1,-1},
    {2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {2,3,8,9,10,-1,-1,-1,-1,-1,-1,-1},
    {0,2,9,10,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,8,10,-1,-1,-1,-1,-1,-1},
    {1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,3,8,9,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1}
};

int edgeToVertsTable[12][2] = {
    {0, 1}, // 0
    {1, 2}, // 1
    {2, 3}, // 2
    {0, 3}, // 3
    {4, 5}, // 4
    {5, 6}, // 5
    {6, 7}, // 6
    {4, 7}, // 7
    {0, 4}, // 8
    {1, 5}, // 9
    {2, 6}, // 10
    {3, 7}, // 11
};

int triTable[256][15] = {
    {-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,2,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,2,1,3,2,0,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,4,3,1,2,5,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {2,1,3,0,1,2,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,2,1,0,4,2,4,3,2,-1,-1,-1,-1,-1,-1},
    {1,2,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,3,1,2,3,0,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,4,0,2,3,5,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,4,1,0,3,4,3,2,4,-1,-1,-1,-1,-1,-1},
    {1,2,0,3,2,1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,3,1,0,2,3,2,4,3,-1,-1,-1,-1,-1,-1},
    {1,2,0,1,4,2,4,3,2,-1,-1,-1,-1,-1,-1},
    {1,0,2,2,0,3,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {2,1,0,3,1,2,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,5,4,2,3,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {2,0,4,2,3,0,3,1,0,-1,-1,-1,-1,-1,-1},
    {0,1,5,4,2,3,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {3,4,5,3,0,4,1,2,6,-1,-1,-1,-1,-1,-1},
    {5,1,6,5,0,1,4,2,3,-1,-1,-1,-1,-1,-1},
    {0,5,4,0,4,3,0,3,1,3,4,2,-1,-1,-1},
    {4,2,3,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {4,2,3,4,1,2,1,0,2,-1,-1,-1,-1,-1,-1},
    {7,0,1,6,4,5,2,3,8,-1,-1,-1,-1,-1,-1},
    {2,3,5,4,2,5,4,5,1,4,1,0,-1,-1,-1},
    {1,5,0,1,6,5,3,4,2,-1,-1,-1,-1,-1,-1},
    {1,5,4,1,2,5,1,0,2,3,5,2,-1,-1,-1},
    {2,3,4,5,0,7,5,7,6,7,0,1,-1,-1,-1},
    {0,1,4,0,4,2,2,4,3,-1,-1,-1,-1,-1,-1},
    {2,1,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {5,3,2,0,4,1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,3,2,1,3,0,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {4,3,2,4,1,3,1,0,3,-1,-1,-1,-1,-1,-1},
    {0,1,5,4,3,2,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {3,0,6,1,2,8,4,7,5,-1,-1,-1,-1,-1,-1},
    {3,1,4,3,2,1,2,0,1,-1,-1,-1,-1,-1,-1},
    {0,5,3,1,0,3,1,3,2,1,2,4,-1,-1,-1},
    {4,3,2,0,1,5,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,6,1,0,4,6,2,5,3,-1,-1,-1,-1,-1,-1},
    {0,5,4,0,1,5,2,3,6,-1,-1,-1,-1,-1,-1},
    {1,0,3,1,3,4,1,4,5,2,4,3,-1,-1,-1},
    {5,1,6,5,0,1,4,3,2,-1,-1,-1,-1,-1,-1},
    {2,5,3,0,4,1,4,6,1,4,7,6,-1,-1,-1},
    {3,2,0,3,0,5,3,5,4,5,0,1,-1,-1,-1},
    {1,0,2,1,2,3,3,2,4,-1,-1,-1,-1,-1,-1},
    {3,1,2,0,1,3,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {4,1,0,4,2,1,2,3,1,-1,-1,-1,-1,-1,-1},
    {0,3,4,0,1,3,1,2,3,-1,-1,-1,-1,-1,-1},
    {0,2,1,1,2,3,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {5,3,4,5,2,3,6,0,1,-1,-1,-1,-1,-1,-1},
    {7,1,2,6,4,0,4,3,0,4,5,3,-1,-1,-1},
    {4,0,1,4,1,2,4,2,3,5,2,1,-1,-1,-1},
    {0,4,2,0,2,1,1,2,3,-1,-1,-1,-1,-1,-1},
    {3,5,2,3,4,5,1,6,0,-1,-1,-1,-1,-1,-1},
    {4,2,3,4,3,1,4,1,0,1,3,5,-1,-1,-1},
    {2,3,7,0,1,6,1,5,6,1,4,5,-1,-1,-1},
    {4,1,0,4,0,3,3,0,2,-1,-1,-1,-1,-1,-1},
    {5,2,4,4,2,3,6,0,1,6,1,7,-1,-1,-1},
    {2,3,0,2,0,4,3,6,0,1,0,5,6,5,0},
    {6,5,0,6,0,1,5,2,0,4,0,3,2,3,0},
    {3,2,0,1,3,0,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {2,1,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,4,1,2,5,3,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {4,0,1,2,5,3,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,4,1,0,5,4,2,6,3,-1,-1,-1,-1,-1,-1},
    {0,3,2,1,3,0,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,5,4,1,2,5,3,0,6,-1,-1,-1,-1,-1,-1},
    {4,3,2,4,0,3,0,1,3,-1,-1,-1,-1,-1,-1},
    {2,5,4,2,4,0,2,0,3,1,0,4,-1,-1,-1},
    {0,1,5,4,3,2,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {6,0,4,6,1,0,5,3,2,-1,-1,-1,-1,-1,-1},
    {0,1,6,2,3,8,4,7,5,-1,-1,-1,-1,-1,-1},
    {2,6,3,0,5,1,5,7,1,5,4,7,-1,-1,-1},
    {3,1,4,3,2,1,2,0,1,-1,-1,-1,-1,-1,-1},
    {0,4,5,0,5,2,0,2,1,2,5,3,-1,-1,-1},
    {1,5,3,0,1,3,0,3,2,0,2,4,-1,-1,-1},
    {1,0,3,1,3,4,4,3,2,-1,-1,-1,-1,-1,-1},
    {1,5,2,0,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {2,1,0,2,5,1,4,3,6,-1,-1,-1,-1,-1,-1},
    {1,7,0,3,8,4,6,2,5,-1,-1,-1,-1,-1,-1},
    {7,4,3,0,6,5,0,5,1,5,6,2,-1,-1,-1},
    {4,0,1,4,3,0,2,5,6,-1,-1,-1,-1,-1,-1},
    {1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1},
    {6,2,5,7,0,3,0,4,3,0,1,4,-1,-1,-1},
    {5,1,6,5,6,2,1,0,6,3,6,4,0,4,6},
    {1,8,0,5,6,2,7,4,3,-1,-1,-1,-1,-1,-1},
    {3,6,4,2,5,1,2,1,0,1,5,7,-1,-1,-1},
    {0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1},
    {6,1,0,6,8,1,6,2,8,5,8,2,3,7,4},
    {6,2,5,1,7,3,1,3,0,3,7,4,-1,-1,-1},
    {3,1,6,3,6,4,1,0,6,5,6,2,0,2,6},
    {0,3,7,0,4,3,0,1,4,8,4,1,6,2,5},
    {2,1,4,2,4,5,0,3,4,3,5,4,-1,-1,-1},
    {3,0,2,1,0,3,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {2,6,3,2,5,6,0,4,1,-1,-1,-1,-1,-1,-1},
    {4,0,1,4,3,0,3,2,0,-1,-1,-1,-1,-1,-1},
    {4,1,0,4,0,3,4,3,2,3,0,5,-1,-1,-1},
    {0,2,4,0,1,2,1,3,2,-1,-1,-1,-1,-1,-1},
    {3,0,6,1,2,7,2,4,7,2,5,4,-1,-1,-1},
    {0,1,2,2,1,3,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {4,1,0,4,0,2,2,0,3,-1,-1,-1,-1,-1,-1},
    {5,2,4,5,3,2,6,0,1,-1,-1,-1,-1,-1,-1},
    {0,4,1,1,4,7,2,5,6,2,6,3,-1,-1,-1},
    {3,7,2,0,1,5,0,5,4,5,1,6,-1,-1,-1},
    {3,2,0,3,0,5,2,4,0,1,0,6,4,6,0},
    {4,3,2,4,1,3,4,0,1,5,3,1,-1,-1,-1},
    {4,6,1,4,1,0,6,3,1,5,1,2,3,2,1},
    {1,4,3,1,3,0,0,3,2,-1,-1,-1,-1,-1,-1},
    {1,0,2,3,1,2,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,4,0,1,2,4,2,3,4,-1,-1,-1,-1,-1,-1},
    {0,3,1,0,5,3,0,4,5,2,3,5,-1,-1,-1},
    {5,2,3,1,5,3,1,3,4,1,4,0,-1,-1,-1},
    {4,2,3,4,3,0,0,3,1,-1,-1,-1,-1,-1,-1},
    {0,1,2,0,2,4,0,4,5,4,2,3,-1,-1,-1},
    {2,4,6,2,6,1,4,5,6,0,6,3,5,3,6},
    {3,4,0,3,0,2,2,0,1,-1,-1,-1,-1,-1,-1},
    {3,1,0,2,3,0,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,7,6,2,4,6,4,5,4,2,3,-1,-1,-1},
    {1,0,3,1,3,6,0,4,3,2,3,5,4,5,3},
    {1,6,0,1,5,6,1,7,5,4,5,7,2,3,8},
    {5,1,0,5,0,3,4,2,0,2,3,0,-1,-1,-1},
    {4,5,2,4,2,3,5,0,2,6,2,1,0,1,2},
    {0,4,1,5,2,3,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {3,4,0,3,0,2,1,5,0,5,2,0,-1,-1,-1},
    {1,2,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,0,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,0,4,5,3,2,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,4,5,3,2,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {4,0,5,4,1,0,6,3,2,-1,-1,-1,-1,-1,-1},
    {4,0,1,2,5,3,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,2,7,3,0,6,4,8,5,-1,-1,-1,-1,-1,-1},
    {1,4,0,1,5,4,2,6,3,-1,-1,-1,-1,-1,-1},
    {2,7,3,0,6,1,6,4,1,6,5,4,-1,-1,-1},
    {3,0,1,2,0,3,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {3,0,4,3,2,0,2,1,0,-1,-1,-1,-1,-1,-1},
    {2,5,4,2,3,5,0,1,6,-1,-1,-1,-1,-1,-1},
    {0,2,1,0,4,2,0,5,4,4,3,2,-1,-1,-1},
    {4,3,2,4,0,3,0,1,3,-1,-1,-1,-1,-1,-1},
    {5,3,2,1,3,5,1,4,3,1,0,4,-1,-1,-1},
    {0,1,3,0,3,5,0,5,4,2,5,3,-1,-1,-1},
    {1,0,4,1,4,2,2,4,3,-1,-1,-1,-1,-1,-1},
    {1,2,0,3,2,1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,3,4,1,0,3,0,2,3,-1,-1,-1,-1,-1,-1},
    {4,3,6,4,2,3,5,0,1,-1,-1,-1,-1,-1,-1},
    {4,2,3,4,3,1,4,1,0,5,1,3,-1,-1,-1},
    {3,4,2,3,6,4,1,5,0,-1,-1,-1,-1,-1,-1},
    {1,2,6,3,0,7,0,5,7,0,4,5,-1,-1,-1},
    {2,7,4,2,3,7,0,1,5,1,6,5,-1,-1,-1},
    {5,4,1,5,1,0,4,2,1,6,1,3,2,3,1},
    {4,0,1,4,2,0,2,3,0,-1,-1,-1,-1,-1,-1},
    {0,2,1,2,3,1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,7,0,2,3,4,2,4,5,4,3,6,-1,-1,-1},
    {0,4,2,0,2,1,1,2,3,-1,-1,-1,-1,-1,-1},
    {4,0,1,4,3,0,4,2,3,3,5,0,-1,-1,-1},
    {4,1,0,4,0,3,3,0,2,-1,-1,-1,-1,-1,-1},
    {2,3,1,2,1,4,3,6,1,0,1,5,6,5,1},
    {3,2,0,1,3,0,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,4,1,3,2,5,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,6,1,2,7,3,8,5,4,-1,-1,-1,-1,-1,-1},
    {3,0,1,3,2,0,5,4,6,-1,-1,-1,-1,-1,-1},
    {7,5,4,6,1,2,1,3,2,1,0,3,-1,-1,-1},
    {6,3,2,7,0,1,5,4,8,-1,-1,-1,-1,-1,-1},
    {6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1},
    {5,4,7,3,2,6,2,1,6,2,0,1,-1,-1,-1},
    {1,2,6,1,3,2,1,0,3,7,3,0,8,5,4},
    {5,0,1,5,4,0,3,2,6,-1,-1,-1,-1,-1,-1},
    {7,3,2,0,6,4,0,4,1,4,6,5,-1,-1,-1},
    {3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1},
    {4,1,6,4,6,5,1,0,6,2,6,3,0,3,6},
    {6,3,2,7,0,4,0,5,4,0,1,5,-1,-1,-1},
    {1,4,8,1,5,4,1,0,5,6,5,0,7,3,2},
    {2,0,6,2,6,3,0,1,6,4,6,5,1,5,6},
    {3,2,5,3,5,4,1,0,5,0,4,5,-1,-1,-1},
    {1,3,0,1,4,3,4,2,3,-1,-1,-1,-1,-1,-1},
    {1,3,5,0,3,1,0,2,3,0,4,2,-1,-1,-1},
    {0,5,4,0,2,5,0,1,2,2,3,5,-1,-1,-1},
    {3,4,1,3,1,2,2,1,0,-1,-1,-1,-1,-1,-1},
    {0,1,6,5,2,7,5,7,4,7,2,3,-1,-1,-1},
    {0,8,3,0,5,8,0,6,5,4,5,6,1,2,7},
    {6,4,2,6,2,3,4,0,2,5,2,1,0,1,2},
    {3,5,1,3,1,2,0,4,1,4,2,1,-1,-1,-1},
    {2,4,5,2,0,4,2,3,0,1,4,0,-1,-1,-1},
    {4,2,3,4,3,0,0,3,1,-1,-1,-1,-1,-1,-1},
    {1,4,6,1,6,0,4,5,6,3,6,2,5,2,6},
    {0,2,3,1,0,3,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,3,0,3,6,1,4,3,2,3,5,4,5,3},
    {5,1,0,5,0,3,4,2,0,2,3,0,-1,-1,-1},
    {0,1,4,2,3,5,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {2,0,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {3,0,2,1,0,3,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {6,2,5,6,3,2,4,1,0,-1,-1,-1,-1,-1,-1},
    {2,6,3,2,5,6,1,4,0,-1,-1,-1,-1,-1,-1},
    {6,3,2,6,7,3,5,4,0,4,1,0,-1,-1,-1},
    {4,0,1,4,3,0,3,2,0,-1,-1,-1,-1,-1,-1},
    {0,6,3,1,2,5,1,5,4,5,2,7,-1,-1,-1},
    {4,3,2,4,1,3,4,0,1,1,5,3,-1,-1,-1},
    {3,2,0,3,0,6,2,5,0,1,0,4,5,4,0},
    {0,2,4,0,1,2,1,3,2,-1,-1,-1,-1,-1,-1},
    {4,1,0,4,2,1,4,3,2,5,1,2,-1,-1,-1},
    {6,0,1,4,7,3,4,3,5,3,7,2,-1,-1,-1},
    {5,4,1,5,1,0,4,3,1,6,1,2,3,2,1},
    {0,1,2,1,3,2,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,4,3,0,3,1,1,3,2,-1,-1,-1,-1,-1,-1},
    {4,0,1,4,1,2,2,1,3,-1,-1,-1,-1,-1,-1},
    {3,2,1,0,3,1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,2,0,1,3,2,3,4,2,-1,-1,-1,-1,-1,-1},
    {3,0,2,3,5,0,3,4,5,5,1,0,-1,-1,-1},
    {0,1,5,4,2,6,4,6,7,6,2,3,-1,-1,-1},
    {5,6,2,5,2,3,6,1,2,4,2,0,1,0,2},
    {1,3,0,1,4,3,1,5,4,2,3,4,-1,-1,-1},
    {0,4,6,0,6,3,4,5,6,2,6,1,5,1,6},
    {0,1,3,0,3,5,1,6,3,2,3,4,6,4,3},
    {4,2,3,0,5,1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,3,5,1,3,0,1,2,3,1,4,2,-1,-1,-1},
    {3,4,1,3,1,2,2,1,0,-1,-1,-1,-1,-1,-1},
    {3,8,2,3,5,8,3,6,5,4,5,6,0,1,7},
    {3,5,1,3,1,2,0,4,1,4,2,1,-1,-1,-1},
    {4,2,3,4,3,1,1,3,0,-1,-1,-1,-1,-1,-1},
    {0,2,3,1,0,3,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {4,2,3,4,3,1,5,0,3,0,1,3,-1,-1,-1},
    {2,0,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,4,1,0,2,4,2,3,4,-1,-1,-1,-1,-1,-1},
    {0,4,1,2,5,3,5,7,3,5,6,7,-1,-1,-1},
    {1,4,5,1,5,2,1,2,0,3,2,5,-1,-1,-1},
    {1,0,2,1,2,4,0,5,2,3,2,6,5,6,2},
    {2,5,3,4,5,2,4,1,5,4,0,1,-1,-1,-1},
    {7,5,4,7,8,5,7,1,8,2,8,1,0,6,3},
    {4,3,2,4,2,1,1,2,0,-1,-1,-1,-1,-1,-1},
    {5,3,2,5,2,0,4,1,2,1,0,2,-1,-1,-1},
    {0,4,5,0,3,4,0,1,3,3,2,4,-1,-1,-1},
    {5,6,3,5,3,2,6,1,3,4,3,0,1,0,3},
    {3,5,6,3,6,2,5,4,6,1,6,0,4,0,6},
    {0,5,1,4,3,2,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {2,4,0,2,0,3,3,0,1,-1,-1,-1,-1,-1,-1},
    {2,5,1,2,1,3,0,4,1,4,3,1,-1,-1,-1},
    {2,0,1,3,2,1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,2,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,2,0,2,3,0,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,0,2,1,2,4,4,2,3,-1,-1,-1,-1,-1,-1},
    {0,1,3,0,3,2,2,3,4,-1,-1,-1,-1,-1,-1},
    {1,0,2,3,1,2,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,4,0,4,3,3,4,2,-1,-1,-1,-1,-1,-1},
    {3,0,4,3,4,5,1,2,4,2,5,4,-1,-1,-1},
    {0,1,3,2,0,3,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,0,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,0,2,4,4,2,3,-1,-1,-1,-1,-1,-1},
    {2,3,1,0,2,1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {2,3,4,2,4,5,0,1,4,1,5,4,-1,-1,-1},
    {0,2,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,3,0,2,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,2,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1}
};

float* data;
int dataLength;
int* codes;
float* verts;
int vertsNum;
float* normals;
int* indices;
int indicesNum;

// size is in bytes
// therefore dataLength is too
float* EMSCRIPTEN_KEEPALIVE assignDataLocation(int dataPoints) {
    dataLength = dataPoints;
    data = malloc(dataPoints * sizeof(float));
    return data;
}

float* EMSCRIPTEN_KEEPALIVE getVertsLocation() {
    return verts;
}

float* EMSCRIPTEN_KEEPALIVE getNormalsLocation() {
    return normals;
}

int* EMSCRIPTEN_KEEPALIVE getIndicesLocation() {
    return indices;
}

int EMSCRIPTEN_KEEPALIVE getIndicesLength() {
    return indicesNum;
}



/*
int  EMSCRIPTEN_KEEPALIVE getCode(float* data, int length, float threshold) {
    int code = 0;
    for (int i = 0; i < 8; i++) {
        float* c = vertCoordTable[i];
        float val = ptr[4*(int)c[0] + 2*(int)c[1] + (int)c[2]];
        code |= (val > threshold) << i;
    }
    return code;
}

int vertsNum = 0;

float inter (float a, float b, float fac) {
    return a*(1-fac) + b*fac;
}
*/
/*
void edgesToVerts(float* data, int* edges, float threshold, int x, int y, int z, float* free) {
    int length = 0;
    for (int i = 0; i < 12; i++) {
        if (edges[i] != -1) {
            const int* connected = edgeToVertsTable[edges[i]];
            float* a = vertCoordTable[connected[0]];
            float* b = vertCoordTable[connected[1]];
            // get values at those cells
            // CHANGE TO USE SIZE
            float va = data[4*((int)a[0] + x) + 2*((int)a[1] + y) + (int)a[2] + z];
            float vb = data[4*((int)b[0] + x) + 2*((int)b[1] + y) + (int)b[2] + z];;
            float fac = (threshold-va)/(vb-va);
            float vert[3] = {
                inter(a[0], b[0], fac) + x,
                inter(a[1], b[1], fac) + y,
                inter(a[2], b[2], fac) + z,
            };
            free[3*i] = vert[0];
            free[3*i + 1] = vert[1];
            free[3*i + 2] = vert[2];
            vertsNum += 1;
        } else {
            break;
        }
    }
}
*/

float* getPointNorm(float* data, int i, int j, int k, int x, int y, int z) {
    float cellSize[3] = {1, 1, 1};
    float d[3];
    float thisVal = data[y*z*i + z*j + k];
    
    // x(i) component
    if (i > 0) {
        if (i < x - 2){
            d[0] = (data[y*z*(i+1) + z*j + k] - data[y*z*(i-1) + z*j + k])/(2*cellSize[0]);
        } else {
            d[0] = (thisVal - data[y*z*(i-1) + z*j + k])/cellSize[0];
        }
    } else {
        d[0] = ((data[y*z*(i+1) + z*j + k] - thisVal)/(cellSize[0]));
    }

    // y(j) component
    if (j > 0) {
        if (j < y - 2){
            d[1] = (data[y*z*i + z*(j+1) + k] - data[y*z*i + z*(j-1) + k])/(2*cellSize[1]);
        } else {
            d[1] = (thisVal - data[y*z*i + z*(j-1) + k])/cellSize[1];
        }
    } else {
        d[1] = ((data[y*z*i + z*(j+1) + k] - thisVal)/(cellSize[1]));
    }

    // z(k) component
    if (k > 0) {
        if (k < z - 2){
            d[2] = (data[y*z*i + z*j + k+1] - data[y*z*i + z*j + k-1])/(2*cellSize[2]);
        } else {
            d[2] = (thisVal - data[y*z*i + z*j + k-1])/cellSize[2];
        }
    } else {
        d[2] = ((data[y*z*i + z*j + k+1] - thisVal)/(cellSize[2]));
    }

    return d;

}

float getPointNormX(float* data, int i, int j, int k, int x, int y, int z) {
    float cellSize[3] = {1, 1, 1};
    float thisVal = data[y*z*i + z*j + k];
    
    // x(i) component
    if (i > 0) {
        if (i < x - 2){
            return (data[y*z*(i+1) + z*j + k] - data[y*z*(i-1) + z*j + k])/(2*cellSize[0]);
        } else {
            return (thisVal - data[y*z*(i-1) + z*j + k])/cellSize[0];
        }
    } else {
        return ((data[y*z*(i+1) + z*j + k] - thisVal)/(cellSize[0]));
    }
}
float getPointNormY(float* data, int i, int j, int k, int x, int y, int z) {
    float cellSize[3] = {1, 1, 1};
    float thisVal = data[y*z*i + z*j + k];
    
    // y(j) component
    if (j > 0) {
        if (j < y - 2){
            return (data[y*z*i + z*(j+1) + k] - data[y*z*i + z*(j-1) + k])/(2*cellSize[1]);
        } else {
            return (thisVal - data[y*z*i + z*(j-1) + k])/cellSize[1];
        }
    } else {
        return ((data[y*z*i + z*(j+1) + k] - thisVal)/(cellSize[1]));
    }
}
float getPointNormZ(float* data, int i, int j, int k, int x, int y, int z) {
    float cellSize[3] = {1, 1, 1};
    float thisVal = data[y*z*i + z*j + k];

    // z(k) component
    if (k > 0) {
        if (k < z - 2){
            return (data[y*z*i + z*j + k+1] - data[y*z*i + z*j + k-1])/(2*cellSize[2]);
        } else {
            return (thisVal - data[y*z*i + z*j + k-1])/cellSize[2];
        }
    } else {
        return ((data[y*z*i + z*j + k+1] - thisVal)/(cellSize[2]));
    }
}

// x, y, z are coords of point, X, Y, Z are the dimensions of the data
void addVertsAndNorms(float* verts, float* normals, int* curr, int code, int x, int y, int z, float* data, int X, int Y, int Z, float threshold) {
    int* edges = edgeTable[code];
    for (int i = 0; i < 12; i++) {
        if (edges[i] != -1) {
            // add vertex position to vertex list
            const int* connected = edgeToVertsTable[edges[i]];

            int* a = vertCoordTable[connected[0]];
            int* b = vertCoordTable[connected[1]];

            float va = data[Y*Z*(a[0] + x) + Z*(a[1] + y) + a[2] + z];
            float vb = data[Y*Z*(b[0] + x) + Z*(b[1] + y) + b[2] + z];
            float fac = (threshold-va)/(vb-va);

            verts[3*(*curr)] = (float)a[0]*(1-fac) + (float)b[0]*fac + x;
            verts[3*(*curr) + 1] = (float)a[1]*(1-fac) + (float)b[1]*fac + y;
            verts[3*(*curr) + 2] = (float)a[2]*(1-fac) + (float)b[2]*fac + z;

            // add vertex normal to normal list

            vert da = {
                getPointNormX(data, (a[0] + x), (a[1] + y), a[2] + z, X, Y, Z),
                getPointNormY(data, (a[0] + x), (a[1] + y), a[2] + z, X, Y, Z),
                getPointNormZ(data, (a[0] + x), (a[1] + y), a[2] + z, X, Y, Z)
            };
            vert db = {
                getPointNormX(data, (b[0] + x), (b[1] + y), b[2] + z, X, Y, Z),
                getPointNormY(data, (b[0] + x), (b[1] + y), b[2] + z, X, Y, Z),
                getPointNormZ(data, (b[0] + x), (b[1] + y), b[2] + z, X, Y, Z)
            };

            normals[3*(*curr)] = da[0]*(1-fac) + db[0]*fac;
            normals[3*(*curr) + 1] = da[1]*(1-fac) + db[1]*fac;
            normals[3*(*curr) + 2] = da[2]*(1-fac) + db[2]*fac;

            (*curr)++;
        } else {
            break;
        }
    }
}

void addIndices(int* indices, int* currInd, int currVert, int code) { 
    int* tri = triTable[code];
    for (int i = 0; i < 15; i++) {
        if (tri[i] != -1) {
            indices[*currInd + i] = tri[i] + currVert;
        } else {
            *currInd += i;
            break;
        }
    }
}

void getCodes(int* codes, float* data, float threshold, int x, int y, int z) {
    int index;
    int X = x-1;
    int Y = y-1;
    int Z = z-1;
    for (int i = 0; i < X; i++) {
        for (int j = 0; j < Y; j++) {
            for (int k = 0; k < Z; k++) {
                codes[Y * Z * i + Z * j + k] = 0;
                for (int l = 0; l < 8; l++) {
                    int* c = vertCoordTable[l];
                    // indexing data needs full dimensions
                    index = y * z * (i + c[0]) + z * (j + c[1]) + k + c[2];
                    float val = data[index];
                    // indexing codes uses X Y Z (dim - 1)
                    codes[Y * Z * i + Z * j + k] |= (val > threshold) << l;
                }
            }
        }
    }
}

int getVertsCount(int* codes, int length) {
    int total = 0;
    for (int i = 0; i < length; i++) {
        // loop through each code
        for (int j = 0; j < 12; j++) {
            if (edgeTable[codes[i]][j] != -1) {
                total++;
            } else {
                break;
            }
        }
    }    
    return total;
}

int getIndicesCount(int* codes, int length) {
    int total = 0;
    for (int i = 0; i < length; i++) {
        // loop through each code
        for (int j = 0; j < 15; j++) {
            if (triTable[codes[i]][j] != -1) {
                total++;
            } else {
                break;
            }
        }
    }    
    return total;
}

// ptr is where the data starts in memory, x, y, z are the sizes
int EMSCRIPTEN_KEEPALIVE generateMesh(int x, int y, int z, float threshold) {
    // potentially could reduce space allocated to codes as they are per cell not per point
    int codesCount = (x - 1) * (y - 1) * (z - 1);  
    codes = (int*) malloc(codesCount * sizeof(int));
    getCodes(codes, data, threshold, x, y, z);

    vertsNum = getVertsCount(codes, codesCount);
    verts = (float*) malloc(vertsNum * 3 * sizeof(float));
    
    indicesNum = getIndicesCount(codes, codesCount);
    indices = (int*) malloc(indicesNum * sizeof(int));

    normals = (float*) malloc(vertsNum * 3 * sizeof(float));
    
    int X = x-1;
    int Y = y-1;
    int Z = z-1;
    // holds current vertex number in array
    int currVert = 0;
    int currInd = 0;
    int codeIndex = 0;
    for (int i = 0; i < X; i++) {
        for (int j = 0; j < Y; j++) {
            for (int k = 0; k < Z; k++) {
                codeIndex = Y * Z * i + Z * j + k;
                // loop throught all generated codes
                if (codes[codeIndex] == 0 || codes[codeIndex] == 255) {
                    continue;
                }
                addIndices(indices, &currInd, currVert, codes[codeIndex]);
                addVertsAndNorms(verts, normals, &currVert, codes[codeIndex], i, j, k, data, x, y, z, threshold);
                // calculate indices values
            }
        }
    }
    //console_log(normals[0]);
    return vertsNum;
}

void EMSCRIPTEN_KEEPALIVE freeMem () {
    free(codes);
    free(verts);
    free(normals);
    free(indices);
}
